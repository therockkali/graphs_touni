define(["./core","./var/slice","./callbacks"],function(e,n){return e.extend({Deferred:function(n){var r=[["resolve","done",e.Callbacks("once memory"),"resolved"],["reject","fail",e.Callbacks("once memory"),"rejected"],["notify","progress",e.Callbacks("memory")]],i="pending",t={state:function(){return i},always:function(){return o.done(arguments).fail(arguments),this},then:function(){var n=arguments;return e.Deferred(function(i){e.each(r,function(r,s){var c=e.isFunction(n[r])&&n[r];o[s[1]](function(){var n=c&&c.apply(this,arguments);n&&e.isFunction(n.promise)?n.promise().progress(i.notify).done(i.resolve).fail(i.reject):i[s[0]+"With"](this===t?i.promise():this,c?[n]:arguments)})}),n=null}).promise()},promise:function(n){return null!=n?e.extend(n,t):t}},o={};return t.pipe=t.then,e.each(r,function(e,n){var s=n[2],c=n[3];t[n[1]]=s.add,c&&s.add(function(){i=c},r[1^e][2].disable,r[2][2].lock),o[n[0]]=function(){return o[n[0]+"With"](this===o?t:this,arguments),this},o[n[0]+"With"]=s.fireWith}),t.promise(o),n&&n.call(o,o),o},when:function(r){var i,t,o,s=0,c=n.call(arguments),a=c.length,l=1!==a||r&&e.isFunction(r.promise)?a:0,u=1===l?r:e.Deferred(),f=function(e,r,t){return function(o){r[e]=this,t[e]=arguments.length>1?n.call(arguments):o,t===i?u.notifyWith(r,t):--l||u.resolveWith(r,t)}};if(a>1)for(i=new Array(a),t=new Array(a),o=new Array(a);a>s;s++)c[s]&&e.isFunction(c[s].promise)?c[s].promise().progress(f(s,t,i)).done(f(s,o,c)).fail(u.reject):--l;return l||u.resolveWith(o,c),u.promise()}}),e});